<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ÏõêÎ¶¨Í∞ïÎ°† ÌÄ¥Ï¶à - ÏóÖÍ∑∏Î†àÏù¥Îìú</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap">
    <style>
        /*
         * ======================================================================
         * üé® CORE STYLES & VARIABLES (Minimal changes, mostly additions)
         * ======================================================================
         */
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --bg-neutral: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-accent: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-border: rgba(255, 255, 255, 0.2);
            --primary-purple: #7c3aed;
            --primary-indigo: #6366f1;
            --primary-pink: #ec4899;
            --primary-emerald: #10b981; /* Success Green */
            --primary-amber: #f59e0b; /* Warning Amber */
            --primary-red: #ef4444; /* Error Red */
            --color-accent: var(--primary-purple); /* For live selection highlight */
            --color-accent-light: rgba(124, 58, 237, 0.3);

            --option-bg: #f1f5f9;
            --option-hover: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(99, 102, 241, 0.05));
            --correct-bg: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.15));
            --incorrect-bg: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(248, 113, 113, 0.15));
            --explanation-bg: linear-gradient(135deg, rgba(148, 163, 184, 0.1), rgba(203, 213, 225, 0.1));
            --progress-bg: rgba(148, 163, 184, 0.2);
            --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 20px 40px rgba(0, 0, 0, 0.15);
            --shadow-strong: 0 25px 50px rgba(0, 0, 0, 0.25);
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --golden-ratio: 1.618;
            --base-font-size: clamp(16px, 4vw, 18px);
            --base-padding: clamp(12px, 3vw, 16px);
            --base-margin: calc(var(--base-padding) * var(--golden-ratio));
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --bg-secondary: linear-gradient(135deg, #581c87 0%, #7c2d12 100%);
            --bg-neutral: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-accent: #e2e8f0;
            --card-bg: rgba(30, 41, 59, 0.95);
            --card-border: rgba(148, 163, 184, 0.1);
            --primary-purple: #a855f7;
            --primary-indigo: #8b5cf6;
            --primary-pink: #f472b6;
            --primary-emerald: #34d399;
            --primary-amber: #fbbf24;
            --primary-red: #f87171;
            --color-accent: var(--primary-purple); 
            --color-accent-light: rgba(168, 85, 247, 0.3);

            --option-bg: rgba(51, 65, 85, 0.5);
            --option-hover: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.1));
            --correct-bg: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.2));
            --incorrect-bg: linear-gradient(135deg, rgba(248, 113, 113, 0.2), rgba(239, 68, 68, 0.2));
            --explanation-bg: linear-gradient(135deg, rgba(51, 65, 85, 0.3), rgba(71, 85, 105, 0.3));
            --progress-bg: rgba(71, 85, 105, 0.4);
            --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-medium: 0 20px 40px rgba(0, 0, 0, 0.4);
            --shadow-strong: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        /* Base styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-primary);
            font-size: var(--base-font-size);
            font-weight: 400;
            overflow-x: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* ------------------ Header & Theme Toggle ------------------ */
        header {
            width: 100%;
            max-width: 600px;
            padding: var(--base-padding) 0;
            text-align: center;
            flex-shrink: 0;
            margin-top: 20px;
        }
        .logo-container {
            height: 50px;
            margin-bottom: 10px;
        }
        .logo-container img {
            height: 100%;
            width: auto;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-soft);
        }
        h1 {
            font-size: clamp(1.5rem, 6vw, 2.2rem);
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .theme-toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-medium);
        }

        /* ------------------ Progress Bar ------------------ */
        #progress {
            width: 90%;
            max-width: 600px;
            margin: var(--base-margin) 0;
            padding: var(--base-padding);
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-accent);
        }
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--progress-bg);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-indigo), var(--primary-purple));
            transition: width 0.4s ease;
            border-radius: 5px;
        }

        /* ------------------ Quiz Main Content ------------------ */
        main {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        #loading {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-top: 50px;
        }
        #quiz-container {
            width: 90%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--base-margin);
            box-shadow: var(--shadow-strong);
            display: none; /* Hidden by default, shown by JS */
            flex-direction: column;
            margin-bottom: var(--base-margin);
            transition: all 0.4s ease;
            min-height: 400px;
            outline: none; /* For JS focus management */
        }
        .question-text {
            font-size: clamp(1.1rem, 5vw, 1.4rem);
            font-weight: 600;
            margin-bottom: var(--base-margin);
            line-height: var(--golden-ratio);
            color: var(--text-accent);
            text-align: justify;
        }

        /* ------------------ Options ------------------ */
        #options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: var(--base-margin);
        }
        .option {
            position: relative;
            background-color: var(--option-bg);
            padding: var(--base-padding);
            border-radius: var(--border-radius);
            border: 2px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            min-height: 50px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none; /* Managed by :focus below */
        }
        .option:focus, .option:hover {
            box-shadow: 0 0 0 3px var(--primary-purple);
            border-color: var(--primary-purple);
            transform: scale(1.02);
            background: var(--option-hover);
        }
        .option label {
            /* Text content within the option div */
            flex-grow: 1;
            cursor: pointer;
            font-weight: 500;
        }
        /* Hide the native checkbox visually */
        .option input {
            display: none; 
        }
        .option.selected {
            border-color: var(--primary-purple);
            background-color: rgba(124, 58, 237, 0.1);
        }

        /* ------------------ Explanation ------------------ */
        .explanation {
            background: var(--explanation-bg);
            padding: var(--base-padding);
            border-radius: var(--border-radius);
            margin-top: var(--base-margin);
            border-left: 5px solid var(--primary-purple);
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.6;
            font-style: italic;
            box-shadow: var(--shadow-soft);
            outline: none; /* For JS focus management */
        }

        /* ------------------ Buttons ------------------ */
        .button-container {
            width: 90%;
            max-width: 600px;
            margin: var(--base-margin) 0 40px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            flex-shrink: 0;
        }
        button {
            flex: 1 1 45%;
            padding: 15px 10px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
            text-align: center;
        }
        button i {
            margin-right: 8px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.purple { background-color: var(--primary-purple); color: white; }
        button.pink { background-color: var(--primary-pink); color: white; }
        button.emerald { background-color: var(--primary-emerald); color: white; }
        button.amber { background-color: var(--primary-amber); color: white; }

        button:not(:disabled):hover, button:not(:disabled):focus {
            transform: translateY(-2px);
            opacity: 0.9;
            box-shadow: var(--shadow-strong);
            outline: none;
        }
        button.active { /* Touch active state */
            transform: translateY(1px) scale(0.98);
        }

        /* ------------------ Confetti ------------------ */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--primary-purple);
            opacity: 0;
            animation: confetti-fall linear infinite;
        }
        .confetti:nth-child(2n) { background-color: var(--primary-pink); }
        .confetti:nth-child(3n) { background-color: var(--primary-emerald); }
        .confetti:nth-child(4n) { background-color: var(--primary-amber); }

        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }
        
        /*
         * ======================================================================
         * ‚ú® UX & A11Y IMPROVEMENT STYLES (New/Modified)
         * ======================================================================
         */

        .question-text .instruction {
            display: block;
            font-size: 0.8em;
            color: var(--text-secondary);
            font-weight: 400;
            margin-top: 5px;
        }

        /* --- Fill-in-the-Blank Live Feedback (User Selection) --- */
        .question-text span.live-fill-in {
            font-weight: 700;
            color: var(--color-accent); /* Í∞ïÏ°∞ÏÉâ */
            border-bottom: 3px solid var(--color-accent);
            padding: 0 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }

        /* --- Fill-in-the-Blank Answer Feedback (After Check) --- */
        
        /* 1. Exact Match (Correct content and order) */
        .question-text span.fill-in-exact {
            font-weight: 700;
            color: var(--primary-emerald);
            border-bottom: 3px solid var(--primary-emerald);
            padding: 0 4px;
        }

        /* 2. Correct word in the correct position (Partial success in 'Order Wrong' state) */
        .question-text span.fill-in-correct-position {
            font-weight: 700;
            color: #ffffff;
            background-color: var(--primary-emerald);
            border-bottom: 3px solid var(--primary-emerald);
            border-radius: 4px;
            padding: 2px 6px;
        }

        /* 3. Correct word but wrong position (Order Wrong state - shows user's selection with warning) */
        .question-text span.fill-in-incorrect-order {
            font-weight: 700;
            color: var(--primary-amber);
            border-bottom: 3px dashed var(--primary-amber); /* Dashed underline for order error */
            padding: 0 4px;
        }

        /* 4. Incorrect Content (Shows the correct answer as a hint) */
        .question-text span.fill-in-wrong-answer {
            font-weight: 700;
            color: var(--primary-red); 
            border-bottom: 3px solid var(--primary-red);
            padding: 0 4px;
        }

        /* --- Selection Badge (UX) --- */
        .selection-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            min-width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-indigo));
            color: white;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 700;
            z-index: 10;
            pointer-events: none; 
            display: none; 
            box-shadow: var(--shadow-soft);
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .option.selected .selection-badge {
            display: block; 
            transform: scale(1); /* Pop-in effect */
        }

        /* --- Option Visual Feedback (After Check) --- */
        
        /* Correct Content & Order */
        .option.correct {
            background: var(--correct-bg);
            border-color: var(--primary-emerald);
            box-shadow: 0 0 10px var(--primary-emerald);
        }

        /* Correct Content, Wrong Order (User's choice that was one of the correct words) */
        .option.correct-content-wrong-order {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.15));
            border-color: var(--primary-amber);
            box-shadow: 0 0 10px var(--primary-amber);
        }

        /* User chose a wrong option */
        .option.incorrect {
            background: var(--incorrect-bg);
            border-color: var(--primary-red);
            box-shadow: 0 0 10px var(--primary-red);
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Correct option that the user MISSED */
        .option.missed-correct {
            border: 2px dashed var(--primary-emerald); 
            background-color: var(--option-bg); /* Keep background subtle */
            opacity: 0.7;
        }
        
        /* --- Integrated Feedback Message Area (Replacing #error-message) --- */
        #feedback-message-area {
            font-size: clamp(1rem, 4vw, 1.2rem);
            font-weight: 600;
            padding: 15px;
            margin: var(--base-margin) 0;
            border-radius: var(--border-radius);
            text-align: center;
            border-left: 5px solid;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
            display: none;
            flex-shrink: 0;
        }

        .feedback-success {
            background-color: #d1fae5; 
            border-color: var(--primary-emerald);
            color: #065f46;
        }

        .feedback-warning {
            background-color: #fffbeb; 
            border-color: var(--primary-amber);
            color: #b45309;
        }

        .feedback-error {
            background-color: #fee2e2; 
            border-color: var(--primary-red);
            color: #991b1b;
        }
        
        [data-theme="dark"] .feedback-success { background-color: #065f46; border-color: var(--primary-emerald); color: #d1fae5; }
        [data-theme="dark"] .feedback-warning { background-color: #b45309; border-color: var(--primary-amber); color: #fffbeb; }
        [data-theme="dark"] .feedback-error { background-color: #991b1b; border-color: var(--primary-red); color: #fee2e2; }

        /* Final message styling */
        .final-message {
            text-align: center;
            padding: 40px 20px !important;
        }

        /* Visually Hidden Utility for ARIA (Accessibility) */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }


        /* ------------------ Media Queries ------------------ */
        @media (max-width: 600px) {
            .button-container {
                flex-direction: column;
                gap: 12px;
                padding: 0 5%;
            }
            button {
                flex: 1 1 100%;
            }
            .theme-toggle-container {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="theme-toggle-container">
        <button class="theme-toggle" id="theme-toggle" aria-label="ÌÖåÎßà Ï†ÑÌôò">
            <i class="fas fa-sun"></i>
        </button>
    </div>

    <header>
        <div class="logo-container">
            <img src="assets/images/FFWPU.png" alt="FFWPU Î°úÍ≥†" aria-label="FFWPU Î°úÍ≥†" loading="lazy">
        </div>
        <h1>ÏõêÎ¶¨Í∞ïÎ°† ÌÄ¥Ï¶à</h1>
    </header>

    <div id="progress" role="status" aria-live="polite">
        <div class="progress-info">
            <span>Î¨∏Ï†ú <span id="current-question">1</span> / <span id="total-questions">?</span></span>
            <span id="score">Ï†êÏàò: 0</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
        </div>
        <div id="highest-score-display" style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">ÏµúÍ≥† Ï†êÏàò: 0</div>
    </div>

    <main>
        <div id="loading" class="loading"><i class="fas fa-spinner fa-spin"></i> Î°úÎî© Ï§ë...</div>
        
        <div id="quiz-container" role="region" aria-label="ÌÄ¥Ï¶à ÎÇ¥Ïö©" tabindex="-1"> 
            <div class="question-text" id="question-text"></div>
            
            <div id="feedback-message-area" role="status" aria-live="polite"></div>

            <div id="options-container"></div>
            <div id="explanation" class="explanation" style="display: none;"></div>
        </div>
    </main>

    <div class="button-container">
        <button id="check-answer" class="purple" aria-label="Ï†ïÎãµ ÌôïÏù∏" title="ÏÑ†ÌÉùÌïú ÎãµÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§." disabled><i class="fas fa-check"></i> Ï†ïÎãµ ÌôïÏù∏</button>
        <button id="next-question" class="pink" style="display: none;" aria-label="Îã§Ïùå Î¨∏Ï†úÎ°ú Ïù¥Îèô"><i class="fas fa-arrow-right"></i> Îã§Ïùå Î¨∏Ï†ú</button>
        <button id="restart-quiz" class="emerald" style="display: none;" aria-label="ÌÄ¥Ï¶à Îã§Ïãú ÏãúÏûë"><i class="fas fa-redo"></i> Îã§Ïãú ÏãúÏûë</button>
        <button id="go-home" class="amber" style="display: none;" aria-label="ÌôàÏúºÎ°ú Í∞ÄÍ∏∞"><i class="fas fa-home"></i> ÌôàÏúºÎ°ú</button> 
    </div>

    <div id="confetti-container" class="confetti-container"></div> 
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let currentQuestionIndex = 0;
            let questions = [];
            let score = 0;
            let originalQuestionText = ""; 
            let selectedOptionElementsInOrder = []; // Track selected option DOM elements in order of selection
            let blanksRequired = 0; 
            let quizStarted = false;

            // --- DOM Elements ---
            const themeToggle = document.getElementById("theme-toggle");
            const body = document.body;
            const checkAnswerBtn = document.getElementById("check-answer");
            const nextQuestionBtn = document.getElementById("next-question");
            const restartQuizBtn = document.getElementById("restart-quiz");
            const goHomeBtn = document.getElementById("go-home");
            const questionTextElement = document.getElementById("question-text");
            const optionsContainer = document.getElementById("options-container");
            const explanationElement = document.getElementById("explanation");
            // **CHANGED**: Using the new integrated feedback area
            const feedbackMessageArea = document.getElementById("feedback-message-area"); 
            const quizContainer = document.getElementById("quiz-container");
            const highestScoreDisplay = document.getElementById("highest-score-display");
            const currentScoreDisplay = document.getElementById("score");


            // --- Initialization and Theme Handling ---

            function initializeTheme() {
                const savedTheme = localStorage.getItem("theme") || "light";
                body.setAttribute("data-theme", savedTheme);
                themeToggle.innerHTML = `<i class="fas fa-${savedTheme === "dark" ? "sun" : "moon"}"></i>`;
            }
            
            initializeTheme();
            displayHighestScore();
            
            // --- Utility Functions ---

            function displayHighestScore() {
                const highestScore = parseInt(localStorage.getItem('highestQuizScore') || '0');
                highestScoreDisplay.textContent = `ÏµúÍ≥† Ï†êÏàò: ${highestScore}`;
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function triggerVibration(pattern) {
                if (navigator.vibrate) navigator.vibrate(pattern);
            }

            function triggerConfetti() {
                const confettiContainer = document.getElementById('confetti-container');
                confettiContainer.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.animationDelay = `${Math.random() * 1.5}s`;
                    confetti.style.animationDuration = `${2 + Math.random() * 1}s`;
                    confettiContainer.appendChild(confetti);
                }
                setTimeout(() => {
                    confettiContainer.innerHTML = '';
                }, 3000);
            }

            /**
             * Shows a feedback message (success, error, or info).
             * @param {string} message The message text.
             * @param {string} type 'success', 'error', 'warning', or 'info'.
             */
            function showFeedback(message, type = 'info') {
                feedbackMessageArea.textContent = message;
                feedbackMessageArea.className = 'feedback-message'; // Reset classes
                feedbackMessageArea.classList.add(`feedback-${type}`);
                feedbackMessageArea.style.display = "block";
                feedbackMessageArea.setAttribute('aria-live', 'polite'); 
            }

            function clearFeedback() {
                feedbackMessageArea.textContent = "";
                feedbackMessageArea.style.display = "none";
                feedbackMessageArea.setAttribute('aria-live', 'off');
            }

            // --- Quiz Logic: Data Fetching ---

            // NOTE: Ensure assets/data/divine_pr.json exists and is accessible.
            fetch("assets/data/divine_pr.json")
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    questions = data;
                    if (questions.length === 0) throw new Error("ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.");
                    shuffleArray(questions);
                    document.getElementById("total-questions").textContent = questions.length;
                    quizContainer.style.display = "flex";
                    document.getElementById("loading").style.display = "none";
                    loadQuestion(currentQuestionIndex);
                    updateProgressBar(currentQuestionIndex + 1, questions.length);
                    quizStarted = true;
                })
                .catch(error => {
                    console.error("JSON ÌååÏùº Î°úÎìú Ïã§Ìå®:", error);
                    showFeedback("ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.", 'error');
                    document.getElementById("loading").style.display = "none";
                });

            // --- Quiz Logic: Question Loading ---

            function loadQuestion(index) {
                const currentQuestion = questions[index];
                
                // Accessibility: Scroll to top of quiz container and focus for context change
                setTimeout(() => {
                    quizContainer.scrollTo({ top: 0, behavior: 'smooth' });
                    quizContainer.setAttribute('tabindex', '-1');
                    quizContainer.focus();
                    quizContainer.removeAttribute('tabindex');
                }, 100);

                selectedOptionElementsInOrder = []; 
                clearFeedback(); 

                blanksRequired = currentQuestion.answers.length;
                originalQuestionText = currentQuestion.question; 
                
                // Initial question text with clear instruction
                questionTextElement.innerHTML = `${originalQuestionText} <span class="instruction">(${blanksRequired}Í∞úÏùò ÎπàÏπ∏ÏùÑ ÏàúÏÑúÎåÄÎ°ú Ï±ÑÏö∞ÏÑ∏Ïöî)</span>`; 
                questionTextElement.setAttribute('aria-label', `ÌòÑÏû¨ ÏßàÎ¨∏: ${originalQuestionText}. ${blanksRequired}Í∞úÏùò ÎπàÏπ∏ÏùÑ ÏàúÏÑúÎåÄÎ°ú Ï±ÑÏö∞ÏÑ∏Ïöî.`);

                optionsContainer.innerHTML = "";
                
                let shuffledOptions = currentQuestion.options.map((option, idx) => ({ option, originalIndex: idx }));
                shuffleArray(shuffledOptions);

                shuffledOptions.forEach((item, i) => {
                    const optionDiv = document.createElement("div");
                    optionDiv.classList.add("option");
                    optionDiv.setAttribute("role", "checkbox"); // ARIA role
                    optionDiv.setAttribute("aria-checked", "false"); // ARIA state
                    optionDiv.setAttribute("tabindex", "0"); // Make div focusable for keyboard navigation
                    optionDiv.setAttribute("aria-label", item.option); // ARIA label

                    // Using hidden input only for technical compatibility, but managing state on the div
                    optionDiv.innerHTML = `
                        <input type="checkbox" class="visually-hidden" name="answer" id="option${i}" value="${item.originalIndex}" aria-hidden="true">
                        <span class="option-text">${item.option}</span>
                        <span class="selection-badge" aria-hidden="true"></span>
                    `;

                    optionDiv.addEventListener("click", () => handleOptionSelection(optionDiv));
                    // Handle keyboard activation
                    optionDiv.addEventListener("keydown", (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleOptionSelection(optionDiv);
                        }
                    });
                    
                    optionsContainer.appendChild(optionDiv);
                });

                explanationElement.style.display = "none";
                checkAnswerBtn.style.display = "block";
                nextQuestionBtn.style.display = "none";
                restartQuizBtn.style.display = "none";
                goHomeBtn.style.display = "inline-block";
                updateCheckButtonState();
            }

            function handleOptionSelection(optionDiv) {
                const checkbox = optionDiv.querySelector('input');
                const isCurrentlyChecked = optionDiv.getAttribute("aria-checked") === "true";

                if (isCurrentlyChecked) {
                    // Unselect
                    optionDiv.setAttribute("aria-checked", "false");
                    checkbox.checked = false;
                    optionDiv.classList.remove("selected");
                    selectedOptionElementsInOrder = selectedOptionElementsInOrder.filter(el => el !== optionDiv);
                } else {
                    // Select
                    if (selectedOptionElementsInOrder.length < blanksRequired) {
                        optionDiv.setAttribute("aria-checked", "true");
                        checkbox.checked = true;
                        optionDiv.classList.add("selected");
                        selectedOptionElementsInOrder.push(optionDiv);
                        triggerVibration(50);
                    } else {
                        showFeedback(`Îçî Ïù¥ÏÉÅ ÏÑ†ÌÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§. ${blanksRequired}Í∞úÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'warning');
                        triggerVibration(200);
                    }
                }

                updateLiveBlanksDisplay(); // Update the displayed blanks based on ordered selections
                updateSelectionBadges(); // Update the numbers on the options
                updateCheckButtonState();
            }

            // Function: Update the badge numbers on selected options (A11Y: aria-posinset/aria-setsize)
            function updateSelectionBadges() {
                document.querySelectorAll('.option').forEach(optionDiv => {
                    optionDiv.querySelector('.selection-badge').textContent = '';
                    optionDiv.removeAttribute("aria-posinset");
                    optionDiv.removeAttribute("aria-setsize");
                });

                selectedOptionElementsInOrder.forEach((optionDiv, index) => {
                    const badge = optionDiv.querySelector('.selection-badge');
                    // Display 1-based index
                    const position = index + 1;
                    badge.textContent = position;
                    optionDiv.setAttribute("aria-posinset", position); 
                    optionDiv.setAttribute("aria-setsize", blanksRequired); 
                });
            }

            // Function called during user selection to display their current choices
            function updateLiveBlanksDisplay() {
                const actualSelectedTextsInOrder = selectedOptionElementsInOrder
                    .map(optionDiv => optionDiv.querySelector('.option-text').textContent);
                
                let currentBlanksHtml = originalQuestionText; 
                let blankIndex = 0;

                currentBlanksHtml = currentBlanksHtml.replace(/___/g, () => {
                    if (blankIndex < actualSelectedTextsInOrder.length) {
                        // Use a dedicated class for live selection display
                        return `<span class="live-fill-in">${actualSelectedTextsInOrder[blankIndex++]}</span>`;
                    }
                    return '___';
                });

                questionTextElement.innerHTML = `${currentBlanksHtml} <span class="instruction">(${blanksRequired}Í∞úÏùò ÎπàÏπ∏ÏùÑ ÏàúÏÑúÎåÄÎ°ú Ï±ÑÏö∞ÏÑ∏Ïöî)</span>`;
            }

            function updateCheckButtonState() {
                const selectedCount = selectedOptionElementsInOrder.length;
                if (selectedCount === blanksRequired) {
                    checkAnswerBtn.disabled = false;
                    checkAnswerBtn.removeAttribute("title");
                } else {
                    checkAnswerBtn.disabled = true;
                    checkAnswerBtn.setAttribute("title", `${blanksRequired}Í∞úÏùò ÎãµÏùÑ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§. (ÌòÑÏû¨ ${selectedCount}Í∞ú ÏÑ†ÌÉù)`);
                }
            }

            function updateProgressBar(current, total) {
                const progressBar = document.getElementById("progress-bar");
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
                document.getElementById("current-question").textContent = current;
                currentScoreDisplay.textContent = `Ï†êÏàò: ${score}`;
            }

            // --- Quiz Logic: Answer Checking ---

            checkAnswerBtn.addEventListener("click", () => {
                const currentQuestion = questions[currentQuestionIndex];
                const userSelectedAnswersInOrder = selectedOptionElementsInOrder
                    .map(optionDiv => optionDiv.querySelector('.option-text').textContent);
                const correctAnswers = currentQuestion.answers; 
                
                if (userSelectedAnswersInOrder.length !== blanksRequired) {
                    showFeedback(`${blanksRequired}Í∞úÏùò ÎãµÏùÑ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§.`, 'error');
                    triggerVibration(200);
                    return;
                }

                const isExactMatch = JSON.stringify(userSelectedAnswersInOrder) === JSON.stringify(correctAnswers);

                // Check if content matches regardless of order
                const userSelectedAnswersSorted = [...userSelectedAnswersInOrder].sort();
                const correctAnswersSorted = [...correctAnswers].sort();
                const isContentMatch = JSON.stringify(userSelectedAnswersSorted) === JSON.stringify(correctAnswersSorted);

                // Disable options
                document.querySelectorAll(".option").forEach((optionDiv) => {
                    optionDiv.style.pointerEvents = "none";
                    optionDiv.setAttribute('tabindex', '-1');
                });

                let feedbackType;

                if (isExactMatch) {
                    score++;
                    showFeedback("Ï†ïÎãµÏûÖÎãàÎã§! üéâ ÏàúÏÑúÍπåÏßÄ ÏôÑÎ≤ΩÌï¥Ïöî!", 'success');
                    triggerConfetti();
                    triggerVibration([100, 50, 100]);
                    feedbackType = "exact";
                } else if (isContentMatch) { 
                    showFeedback("ÏïÑÏâΩÏßÄÎßå ÏàúÏÑúÍ∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§. üòî Ï†ïÎãµÍ≥º ÏàúÏÑúÎ•º Îã§Ïãú ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.", 'warning');
                    triggerVibration(200);
                    feedbackType = "order_wrong";
                } else { 
                    showFeedback("Ïò§ÎãµÏûÖÎãàÎã§. üòî Ï†ïÎãµÏùÑ ÌôïÏù∏ÌïòÍ≥† ÌïôÏäµÌï¥Î≥¥ÏÑ∏Ïöî.", 'error');
                    triggerVibration(200);
                    feedbackType = "content_wrong";
                }

                // Apply visual feedback to question text and options
                displayAnswerFeedbackInBlanks(userSelectedAnswersInOrder, correctAnswers, feedbackType);
                applyOptionVisualFeedback(currentQuestion, feedbackType);
                
                // Show Explanation and focus on it for A11Y
                explanationElement.textContent = currentQuestion.explanation;
                explanationElement.style.display = "block";
                explanationElement.setAttribute('tabindex', '0');
                explanationElement.focus();
                explanationElement.removeAttribute('tabindex');

                checkAnswerBtn.style.display = "none";
                nextQuestionBtn.style.display = "block";
                nextQuestionBtn.focus();
                updateProgressBar(currentQuestionIndex + 1, questions.length);

                const highestScore = parseInt(localStorage.getItem('highestQuizScore') || '0');
                if (score > highestScore) {
                    localStorage.setItem('highestQuizScore', score);
                    displayHighestScore();
                }
            });

            // Function to apply visual feedback to the option blocks
            function applyOptionVisualFeedback(currentQuestion, feedbackType) {
                const correctAnswers = currentQuestion.answers; 

                document.querySelectorAll(".option").forEach((optionDiv) => {
                    const optionText = optionDiv.querySelector('.option-text').textContent;
                    const isOptionChecked = optionDiv.getAttribute("aria-checked") === "true";
                    
                    optionDiv.classList.remove("selected", "correct", "incorrect", "correct-content-wrong-order", "missed-correct");
                    optionDiv.querySelector('.selection-badge').style.display = 'none'; // Hide badge after checking

                    if (feedbackType === "exact") {
                        if (isOptionChecked) optionDiv.classList.add("correct");
                    } else if (feedbackType === "order_wrong") {
                        if (isOptionChecked) optionDiv.classList.add("correct-content-wrong-order");
                    } else { // content_wrong
                        if (correctAnswers.includes(optionText)) {
                            // Correct options were missed (not selected)
                            if (!isOptionChecked) {
                                optionDiv.classList.add("missed-correct");
                            } else {
                                // User selected a correct word, but missed others/got order wrong (fallback state)
                                optionDiv.classList.add("correct-content-wrong-order");
                            }
                        } else if (isOptionChecked) {
                            optionDiv.classList.add("incorrect"); // User selected a definitively wrong option
                        }
                    }
                });
            }

            // Function to display feedback in the blanks based on the answer result
            function displayAnswerFeedbackInBlanks(userSelectedAnswers, correctAnswers, feedbackType) {
                let finalBlanksHtml = originalQuestionText; 
                let blankIdx = 0;

                finalBlanksHtml = finalBlanksHtml.replace(/___/g, () => {
                    const currentUserWord = userSelectedAnswers[blankIdx]; 
                    const currentCorrectWord = correctAnswers[blankIdx];
                    let displayHtml = '';

                    if (feedbackType === "exact") {
                        displayHtml = `<span class="fill-in-exact">${currentUserWord}</span>`;
                    } else if (feedbackType === "order_wrong") {
                        if (currentUserWord === currentCorrectWord) {
                            displayHtml = `<span class="fill-in-correct-position">${currentUserWord}</span>`; 
                        } else {
                            // Show user's word with an "incorrect order" style
                            displayHtml = `<span class="fill-in-incorrect-order" title="Ï†ïÎãµ: ${currentCorrectWord}">${currentUserWord || '___'}</span>`;
                        }
                    } else { // content_wrong
                        // Show the correct word as a hint
                        displayHtml = `<span class="fill-in-wrong-answer" title="Ï†ïÎãµ">${currentCorrectWord}</span>`; 
                    }
                    blankIdx++;
                    return displayHtml;
                });

                questionTextElement.innerHTML = `${finalBlanksHtml} <span class="instruction">(${blanksRequired}Í∞úÏùò ÎπàÏπ∏ÏùÑ ÏàúÏÑúÎåÄÎ°ú Ï±ÑÏö∞ÏÑ∏Ïöî)</span>`;
            }

            // --- Quiz Logic: Navigation ---

            nextQuestionBtn.addEventListener("click", () => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    loadQuestion(currentQuestionIndex);
                    updateProgressBar(currentQuestionIndex + 1, questions.length);
                } else {
                    endQuiz();
                }
            });

            function endQuiz() {
                const finalScoreMessage = `ÌÄ¥Ï¶à ÏôÑÎ£å! ÏàòÍ≥†ÌïòÏÖ®ÏäµÎãàÎã§!<br>ÏµúÏ¢Ö Ï†êÏàò: ${score} / ${questions.length}`;
                
                // Completely replace quiz content with final message
                const finalContent = `
                    <div class="question-text final-message">${finalScoreMessage}</div>
                `;
                quizContainer.innerHTML = finalContent;
                quizContainer.setAttribute('tabindex', '-1');
                quizContainer.focus();
                quizContainer.removeAttribute('tabindex');
                
                nextQuestionBtn.style.display = "none";
                checkAnswerBtn.style.display = "none";
                restartQuizBtn.style.display = "block";
                goHomeBtn.style.display = "block";
                restartQuizBtn.focus();
                clearFeedback();
                explanationElement.style.display = "none";
                
                displayHighestScore();
            }

            restartQuizBtn.addEventListener("click", () => {
                // The most robust way to fully reset the DOM and JS state is a reload
                location.reload(); 
            });

            goHomeBtn.addEventListener("click", () => {
                window.location.href = "/";
            });
            
            // --- Event Listeners and Theme Toggle ---

            themeToggle.addEventListener("click", () => {
                const currentTheme = body.getAttribute("data-theme");
                const newTheme = currentTheme === "light" ? "dark" : "light";
                body.setAttribute("data-theme", newTheme);
                localStorage.setItem("theme", newTheme);
                themeToggle.innerHTML = `<i class="fas fa-${newTheme === "dark" ? "sun" : "moon"}"></i>`;
                triggerVibration(50);
            });

            // Ensure buttons handle touch/keyboard focus properly (touch active state)
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.classList.add('active');
                }, {passive: true});
                button.addEventListener('touchend', function() {
                    this.classList.remove('active');
                });
            });
        });
    </script>
</body>
</html>
